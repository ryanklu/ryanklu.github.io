<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Realtime Chatroom with Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; max-width: 420px; margin: 32px auto; }
    h2 { text-align: center; }
    #chat { border: 1px solid #ccc; border-radius: 5px; height: 320px; overflow-y: auto; padding: 8px; margin-bottom: 12px; background: #f8f8f8; }
    .msg { margin-bottom: 8px; }
    .msg .user { font-weight: bold; margin-right: 8px; }
    #inputArea { display: flex; }
    #message { flex: 1; padding: 8px; }
    #send { padding: 8px 16px; }
    #loginArea, #signupArea {
      border: 1px solid #ccc; border-radius: 5px; padding: 18px; background: #f8f8f8; margin-top: 40px;
    }
    input[type=email], input[type=password], input[type=text] {
      width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px;
    }
    button { padding: 8px 16px; }
    #logout { float: right; margin-bottom: 8px; }
    .error { color: red; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Realtime Chatroom</h2>
  <div id="mainArea"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    // TODO: Replace with your Firebase config below:
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // --- UI Functions ---
    function showLogin(errorMsg = "") {
      document.getElementById('mainArea').innerHTML = `
        <div id="loginArea">
          <h3>Login</h3>
          <form id="loginForm">
            <input id="loginEmail" type="email" placeholder="Email" required autocomplete="username" />
            <input id="loginPass" type="password" placeholder="Password" required autocomplete="current-password" />
            <button type="submit">Login</button>
          </form>
          <button id="showSignup">Create an account</button>
          <div class="error">${errorMsg}</div>
        </div>
      `;
      document.getElementById('loginForm').onsubmit = doLogin;
      document.getElementById('showSignup').onclick = () => showSignup();
    }
    function showSignup(errorMsg = "") {
      document.getElementById('mainArea').innerHTML = `
        <div id="signupArea">
          <h3>Sign Up</h3>
          <form id="signupForm">
            <input id="signupEmail" type="email" placeholder="Email" required autocomplete="username" />
            <input id="signupPass" type="password" placeholder="Password (6+ chars)" required autocomplete="new-password" />
            <button type="submit">Sign Up</button>
          </form>
          <button id="showLogin">Already have an account?</button>
          <div class="error">${errorMsg}</div>
        </div>
      `;
      document.getElementById('signupForm').onsubmit = doSignup;
      document.getElementById('showLogin').onclick = () => showLogin();
    }
    function showChat(user) {
      document.getElementById('mainArea').innerHTML = `
        <button id="logout">Logout</button>
        <div style="margin-bottom: 18px;">Logged in as <b>${escapeHtml(user.displayName || user.email.split('@')[0])}</b></div>
        <div id="chat"></div>
        <form id="inputArea" autocomplete="off" style="margin-top:24px;">
          <input id="message" type="text" placeholder="Type a message..." required autofocus autocomplete="off"/>
          <button id="send" type="submit">Send</button>
        </form>
      `;
      document.getElementById('logout').onclick = () => auth.signOut();
      startChat(user);
    }
    function escapeHtml(text) {
      return text.replace(/[&<"'>]/g, m =>
        ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]);
    }

    // --- Login/signup logic ---
    async function doLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPass').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch (err) {
        showLogin("Login failed. " + err.message);
      }
    }
    async function doSignup(e) {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const pass = document.getElementById('signupPass').value;
      try {
        await auth.createUserWithEmailAndPassword(email, pass);
        // You might want to prompt for/display name, here we just use email prefix
      } catch (err) {
        showSignup("Sign up failed. " + err.message);
      }
    }

    // --- Chat logic ---
    let chatRef = null, chatListener = null;
    function startChat(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      const chatDiv = document.getElementById('chat');
      const inputForm = document.getElementById('inputArea');
      const messageInput = document.getElementById('message');

      chatDiv.innerHTML = ''; // clear messages
      // Remove old listener if any
      if (chatListener && chatRef) chatRef.off('child_added', chatListener);

      chatRef = db.ref('messages');
      chatListener = (snapshot) => {
        const msg = snapshot.val();
        addMessage(msg.username, msg.text);
      };
      chatRef.limitToLast(50).on('child_added', chatListener);

      function addMessage(user, text) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<span class="user">${escapeHtml(user)}:</span> ${escapeHtml(text)}`;
        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }

      inputForm.onsubmit = function(e) {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text) {
          chatRef.push({
            username: displayName,
            text,
            timestamp: Date.now()
          });
          messageInput.value = '';
        }
      };
    }

    // --- Auth observer ---
    auth.onAuthStateChanged(user => {
      if (user) {
        showChat(user);
      } else {
        showLogin();
        // Remove listener if signed out
        if(chatListener && chatRef) chatRef.off('child_added', chatListener);
      }
    });
  </script>
</body>
</html>
